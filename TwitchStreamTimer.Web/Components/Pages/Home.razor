@page "/"
@inject ITimerManager TimerManager
@inject IUserContext UserContext
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Stream Timer Dashboard</PageTitle>

@if (!UserContext.IsAuthenticated)
{
    <MudContainer MaxWidth="MaxWidth.Medium" Class="mt-16">
        <MudPaper Class="pa-8" Elevation="4">
            <MudStack Spacing="4" AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Primary" />
                <MudText Typo="Typo.h4">Login Required</MudText>
                <MudText Typo="Typo.body1" Align="Align.Center">
                    Please login with Twitch to access your personal stream timer.
                </MudText>
                <button class="mud-button-root mud-button mud-button-filled mud-button-filled-primary mud-button-filled-size-large mt-4" 
                        onclick="window.openPopup('/auth/start')">
                    <span class="mud-button-label">
                        <svg class="mud-icon-root mud-svg-icon mud-icon-size-medium mud-button-icon-start" focusable="false" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M0 0h24v24H0z" fill="none"/><path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/>
                        </svg>
                        Login with Twitch
                    </span>
                </button>
            </MudStack>
        </MudPaper>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h5">Welcome, @UserContext.GetCurrentUserName()!</MudText>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="Logout" StartIcon="@Icons.Material.Filled.Logout">Logout</MudButton>
        </MudStack>
        
        <MudTabs Elevation="4" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
            <MudTabPanel Text="Dashboard" Icon="@Icons.Material.Filled.Dashboard">
                @if (_timerService == null)
                {
                    <MudAlert Severity="Severity.Warning">Loading timer...</MudAlert>
                }
                else
                {
                <MudGrid>
                    <!-- Status Row -->
                    <MudItem xs="12" md="6">
                        <MudCard Elevation="25" Class="pa-4" Style="@($"background-color: {_config.BackgroundColor};")">
                            <MudCardContent>
                                 <MudText Typo="Typo.overline">Current Timer</MudText>
                                 
                                 @if (_timerService.State.IsStopped)
                                 {
                                     <MudText Typo="Typo.h1" Color="Color.Error">STOPPED</MudText>
                                 }
                                 else
                                 {
                                     <MudText Typo="Typo.h1" Style="@($"color: {_config.TextColor};")">
                                        @FormatTime(_remainingTime)
                                     </MudText>
                                 }
                                 
                                 <MudStack Row="true" Class="mt-4">
                                     <MudChip T="string" Label="true" Color="Color.Primary">Added: @FormatTime(TimeSpan.FromSeconds(_timerService.State.TotalAddedSeconds))</MudChip>
                                     <MudChip T="string" Label="true" Variant="Variant.Outlined">Status: @(_timerService.IsRunning ? "Running" : (_timerService.State.IsStopped ? "Stopped" : "Paused"))</MudChip>
                                 </MudStack>
                            </MudCardContent>
                            <MudCardActions>
                                @if (_timerService.State.IsStopped)
                                {
                                    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Large" OnClick="_timerService.Start" StartIcon="@Icons.Material.Filled.PlayArrow">Start Stream</MudButton>
                                }
                                else if (_timerService.State.IsPaused)
                                {
                                    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Large" OnClick="_timerService.Start" StartIcon="@Icons.Material.Filled.PlayArrow">Resume</MudButton>
                                    <MudButton Variant="Variant.Outlined" Color="Color.Error" Class="ml-4" OnClick="ConfirmStop" StartIcon="@Icons.Material.Filled.Stop">Stop</MudButton>
                                }
                                else
                                {
                                    <MudButton Variant="Variant.Filled" Color="Color.Warning" Size="Size.Large" OnClick="_timerService.Pause" StartIcon="@Icons.Material.Filled.Pause">Pause</MudButton>
                                    <MudButton Variant="Variant.Outlined" Color="Color.Error" Class="ml-4" OnClick="ConfirmStop" StartIcon="@Icons.Material.Filled.Stop">Stop</MudButton>
                                }
                                
                                <MudButton Variant="Variant.Text" Color="Color.Default" Class="ml-auto" OnClick="ConfirmReset" StartIcon="@Icons.Material.Filled.Refresh">Reset</MudButton>
                                <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="ConfirmHardReset" StartIcon="@Icons.Material.Filled.DeleteForever">Hard Reset</MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>

                    <!-- OBS Overlay Link -->
                    <MudItem xs="12" md="6">
                        <MudCard Elevation="25" Class="pa-4">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6">OBS Overlay Link</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudTextField @bind-Value="_overlayUrl" Label="Overlay URL" Variant="Variant.Outlined" ReadOnly="true" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.ContentCopy" OnAdornmentClick="CopyOverlayLink" />
                                <MudText Typo="Typo.caption" Class="mt-2">Use this URL in OBS Browser Source without login</MudText>
                            </MudCardContent>
                            <MudCardActions>
                                <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Refresh" OnClick="RegenerateToken">Regenerate Token</MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>

                    <!-- Twitch Connection Manager -->
                    <MudItem xs="12" md="6">
                        <MudCard Elevation="25" Class="pa-4">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6">Twitch Connection</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudStack Spacing="3">
                                    <MudSwitch T="bool" @bind-Value="_isSimulationMode" Color="Color.Warning" Label="Simulation Mode (Offline)" />
                                    
                                    @if (!_isSimulationMode)
                                    {
                                        <MudRadioGroup T="bool" @bind-Value="_monitorOwnChannel">
                                            <MudRadio Value="true" Color="Color.Primary">Monitor My Channel (@UserContext.GetCurrentUserName())</MudRadio>
                                            <MudRadio Value="false" Color="Color.Secondary">Monitor Other Channel</MudRadio>
                                        </MudRadioGroup>

                                        @if (!_monitorOwnChannel)
                                        {
                                            <MudTextField @bind-Value="_targetChannel" Label="Target Channel Name" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" />
                                        }
                                    }

                                    <MudDivider />

                                    @if (TwitchService.IsChatConnected || TwitchService.IsEventSubConnected)
                                    {
                                         <MudAlert Severity="Severity.Success" Variant="Variant.Filled">
                                             Connected to: <b>@(TwitchService.CurrentMonitoredChannel ?? "Unknown")</b>
                                         </MudAlert>
                                         <MudButton Variant="Variant.Outlined" Color="Color.Error" FullWidth="true" OnClick="DisconnectTwitch">Disconnect</MudButton>
                                    }
                                    else
                                    {
                                         <MudAlert Severity="Severity.Warning" Variant="Variant.Filled">Disconnected</MudAlert>
                                         @if (!_isSimulationMode)
                                         {
                                            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="ConnectTwitch">Connect</MudButton>
                                         }
                                    }
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>

                     <!-- Event Log (Bottom of Dashboard) -->
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">Recent Events</MudText>
                        <MudTable Items="@_timerService.State.EventLog.AsEnumerable().Reverse().Take(20)" Dense="true" Hover="true" Striped="true">
                            <HeaderContent>
                                <MudTh>Time</MudTh>
                                <MudTh>User</MudTh>
                                <MudTh>Event</MudTh>
                                <MudTh>Added</MudTh>
                                <MudTh>Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@context.Timestamp.ToLocalTime().ToString("HH:mm:ss")</MudTd>
                                <MudTd>@context.UserDisplay</MudTd>
                                <MudTd>@context.Description</MudTd>
                                <MudTd Style="color:#00e676; font-weight:bold;">+@context.SecondsAdded s</MudTd>
                                <MudTd>
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteEvent(context.Id))" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudItem>
                </MudGrid>
                }
            </MudTabPanel>

            <MudTabPanel Text="Settings" Icon="@Icons.Material.Filled.Settings">
                <MudGrid>
                     <MudItem xs="12">
                         <MudText Typo="Typo.h6">General Configuration</MudText>
                         <MudGrid>
                             <MudItem xs="12" md="6">
                                 <MudTextField @bind-Value="_startTimeText" Label="Stream Start Time (Local)" Variant="Variant.Outlined" HelperText="Format: yyyy-MM-dd HH:mm (e.g., 2026-02-01 20:00)" />
                             </MudItem>
                             <MudItem xs="12" md="6">
                                 <MudNumericField @bind-Value="_config.MinDurationSeconds" Label="Minimum Duration (Seconds)" Variant="Variant.Outlined" HelperText="Base duration (e.g. 86400 for 24h)" />
                                 <MudNumericField @bind-Value="_config.MaxDurationSeconds" Label="Max Duration (Seconds)" Variant="Variant.Outlined" Class="mt-2" HelperText="Hard cap (Optional)" />
                             </MudItem>
                         </MudGrid>
                     </MudItem>
                     
                     <MudItem xs="12"><MudDivider Class="my-4"/></MudItem>
                     
                     <MudItem xs="12">
                         <MudText Typo="Typo.h6">Display Customization</MudText>
                         <MudGrid>
                             <MudItem xs="12" md="6">
                                 <MudColorPicker @bind-Value="_backgroundColor" Label="Background Color" Variant="Variant.Outlined" ColorPickerMode="ColorPickerMode.HEX" />
                             </MudItem>
                             <MudItem xs="12" md="6">
                                 <MudColorPicker @bind-Value="_textColor" Label="Text Color" Variant="Variant.Outlined" ColorPickerMode="ColorPickerMode.HEX" />
                             </MudItem>
                         </MudGrid>
                     </MudItem>


                     <MudItem xs="12">
                         <MudText Typo="Typo.h6">Timer Rules</MudText>
                         <MudGrid>
                            <MudItem xs="6" md="3"><MudNumericField @bind-Value="_config.SecondsPerSubTier1" Label="Sub T1" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentText="sec" /></MudItem>
                            <MudItem xs="6" md="3"><MudNumericField @bind-Value="_config.SecondsPerSubTier2" Label="Sub T2" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentText="sec" /></MudItem>
                            <MudItem xs="6" md="3"><MudNumericField @bind-Value="_config.SecondsPerSubTier3" Label="Sub T3" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentText="sec" /></MudItem>
                            <MudItem xs="6" md="3"><MudNumericField @bind-Value="_config.SecondsPerPrimeSub" Label="Prime Sub" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentText="sec" /></MudItem>
                            
                            <MudItem xs="6" md="6"><MudNumericField @bind-Value="_config.MinBitsToTrigger" Label="Minimum Bits" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="6" md="6"><MudNumericField @bind-Value="_config.SecondsPerBits" Label="Seconds Multiplier" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentText="sec" HelperText="Seconds added per (Bits / MinBits) chunk." /></MudItem>
                         </MudGrid>
                     </MudItem>

                     <MudItem xs="12" Class="d-flex justify-end">
                         <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" OnClick="SaveConfig">Save Configuration</MudButton>
                     </MudItem>
                </MudGrid>
            </MudTabPanel>

            <MudTabPanel Text="Manual Actions" Icon="@Icons.Material.Filled.Build">
                 <MudGrid>
                    <MudItem xs="12"><MudText>Manually add Subs/Bits if they were missed or for testing.</MudText></MudItem>
                    
                    <MudItem xs="12"><MudText Typo="Typo.h6" Class="mt-4">Add Subscriptions</MudText></MudItem>
                    <MudItem xs="3">
                        <MudNumericField @bind-Value="_subCount" Label="Count" Variant="Variant.Outlined" Min="1" />
                    </MudItem>
                    <MudItem xs="3"><MudButton FullWidth="true" Variant="Variant.Filled" Color="Color.Secondary" OnClick="@(() => AddManualSubs("1000", _subCount))">Add Sub T1</MudButton></MudItem>
                    <MudItem xs="3"><MudButton FullWidth="true" Variant="Variant.Filled" Color="Color.Secondary" OnClick="@(() => AddManualSubs("2000", _subCount))">Add Sub T2</MudButton></MudItem>
                    <MudItem xs="3"><MudButton FullWidth="true" Variant="Variant.Filled" Color="Color.Secondary" OnClick="@(() => AddManualSubs("3000", _subCount))">Add Sub T3</MudButton></MudItem>
                    
                    <MudItem xs="12"><MudText Typo="Typo.h6" Class="mt-4">Add Bits</MudText></MudItem>
                    <MudItem xs="4">
                        <MudNumericField @bind-Value="_manualBits" Label="Bits Amount" Variant="Variant.Outlined" Min="1" />
                    </MudItem>
                    <MudItem xs="4">
                        <MudNumericField @bind-Value="_bitsCount" Label="Count" Variant="Variant.Outlined" Min="1" />
                    </MudItem>
                    <MudItem xs="4">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddManualBits" FullWidth="true">Add Bits</MudButton>
                    </MudItem>
                </MudGrid>
            </MudTabPanel>
        </MudTabs>
    </MudContainer>
}

@code {
    private ITimerService _timerService;
    private TimeSpan _remainingTime;
    private System.Timers.Timer _uiTimer;
    private TimerConfig _config = new();
    private string _startTimeText = "";
    private int _manualBits = 100;
    private int _subCount = 1;
    private int _bitsCount = 1;
    private MudBlazor.Utilities.MudColor _backgroundColor;
    private MudBlazor.Utilities.MudColor _textColor;
    private string _overlayUrl = "";

    // New Fields for Connection Manager
    private bool _monitorOwnChannel = true;
    private string _targetChannel = "";
    private bool _isSimulationMode = false;

    private async Task ConnectTwitch()
    {
        try
        {
            var userId = UserContext.GetCurrentUserId();
            var userName = UserContext.GetCurrentUserName();
            var accessToken = UserContext.GetTwitchAccessToken();
            
            if (string.IsNullOrEmpty(accessToken))
            {
                Snackbar.Add("No Access Token found. Please Login again.", Severity.Error);
                return;
            }

            // Set session for timer routing
            TwitchService.ActiveTimerUserId = userId;
            
            if (_monitorOwnChannel)
            {
                 // Using Chat Client for Own Channel as well for consistency and robustness
                 await TwitchService.ConnectChat(userName, accessToken, userName);
            }
            else
            {
                if (string.IsNullOrWhiteSpace(_targetChannel)) 
                {
                    Snackbar.Add("Please enter a channel name", Severity.Warning);
                    return;
                }
                await TwitchService.ConnectChat(userName, accessToken, _targetChannel);
            }
            Snackbar.Add("Connecting...", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Connection Failed: {ex.Message}", Severity.Error);
        }
    }

    private async Task DisconnectTwitch()
    {
        await TwitchService.DisconnectAsync();
        Snackbar.Add("Disconnected", Severity.Info);
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        try
        {
            if (!UserContext.IsAuthenticated)
                return;
                
            var userId = UserContext.GetCurrentUserId();
            _timerService = TimerManager.GetUserTimer(userId);
            _config = _timerService.Config;
            
            var localStart = _config.StartTime.ToLocalTime();
            _startTimeText = localStart.ToString("yyyy-MM-dd HH:mm");
            
            _backgroundColor = new MudBlazor.Utilities.MudColor(_config.BackgroundColor);
            _textColor = new MudBlazor.Utilities.MudColor(_config.TextColor);

            UpdateOverlayUrl();

            _uiTimer = new System.Timers.Timer(1000);
            _uiTimer.Elapsed += (s, e) => InvokeAsync(RefreshUI);
            _uiTimer.Start();
            RefreshUI();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in OnInitialized: {ex}");
        }
    }

    private void RefreshUI()
    {
        if (_timerService != null)
        {
            _remainingTime = _timerService.RemainingTime;
            StateHasChanged();
        }
    }

    private async Task AddManualSubs(string tier, int count)
    {
        if (_timerService == null)
        {
            Snackbar.Add("Timer not initialized", Severity.Error);
            return;
        }
        
        try
        {
            await _timerService.QueueSub("manual-user", "ManualAction", tier, false, count);
            Snackbar.Add($"Added {count}x Sub Tier {tier}", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task AddManualBits()
    {
        if (_timerService == null)
        {
            Snackbar.Add("Timer not initialized", Severity.Error);
            return;
        }
        
        try
        {
            await _timerService.QueueBits("manual-user", "ManualAction", _manualBits, _bitsCount);
            Snackbar.Add($"Added {_bitsCount}x {_manualBits} Bits", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
    
    private void DeleteEvent(string eventId)
    {
        if (_timerService == null)
        {
            Snackbar.Add("Timer not initialized", Severity.Error);
            return;
        }
        
        try
        {
            _timerService.DeleteEvent(eventId);
            Snackbar.Add("Event deleted", Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void SaveConfig()
    {
        if (_timerService == null)
        {
            Snackbar.Add("Timer not initialized", Severity.Error);
            return;
        }
        
        try
        {
            if (DateTime.TryParseExact(_startTimeText, "yyyy-MM-dd HH:mm", null, System.Globalization.DateTimeStyles.None, out var parsedDate))
            {
                var offset = TimeZoneInfo.Local.GetUtcOffset(parsedDate);
                _config.StartTime = new DateTimeOffset(parsedDate, offset);
                _config.InitialStartTime = _config.StartTime;
            }
            else
            {
                Snackbar.Add("Invalid date format! Use yyyy-MM-dd HH:mm", Severity.Warning);
                return;
            }
            
            _config.BackgroundColor = _backgroundColor.ToString(MudBlazor.Utilities.MudColorOutputFormats.Hex);
            _config.TextColor = _textColor.ToString(MudBlazor.Utilities.MudColorOutputFormats.Hex);

            _timerService.UpdateConfig(_config);
            Snackbar.Add("Configuration Saved!", Severity.Success);
        }
        catch (Exception ex)
        {
             Snackbar.Add($"Error saving config: {ex.Message}", Severity.Error);
             Console.WriteLine(ex);
        }
    }
    
    private async Task ConfirmStop()
    {
        bool? result = await DialogService.ShowMessageBox(
            "Stop Timer?", 
            "Are you sure you want to STOP the timer? This will end the current session.", 
            yesText: "Stop", cancelText: "Cancel");
            
        if (result == true)
        {
            _timerService.Stop();
            Snackbar.Add("Timer Stopped", Severity.Error);
        }
    }

    private async Task ConfirmReset()
    {
         bool? result = await DialogService.ShowMessageBox(
            "Reset Timer?", 
            "Are you sure? This will wipe the event log and added time!", 
            yesText: "Reset", cancelText: "Cancel");
            
        if (result == true)
        {
            _timerService.Reset();
            Snackbar.Add("Timer Reset", Severity.Warning);
        }
    }
    
    private async Task ConfirmHardReset()
    {
         bool? result = await DialogService.ShowMessageBox(
            "Hard Reset?", 
            "This will DELETE ALL EVENTS and reset the timer completely. This cannot be undone!", 
            yesText: "Hard Reset", cancelText: "Cancel");
            
        if (result == true)
        {
            _timerService.State.EventLog.Clear();
            _timerService.State.TotalAddedSeconds = 0;
            _timerService.Reset();
            Snackbar.Add("Hard Reset Complete", Severity.Error);
        }
    }
    
    private string FormatTime(TimeSpan ts)
    {
        int totalHours = (int)ts.TotalHours;
        int minutes = ts.Minutes;
        int seconds = ts.Seconds;
        return $"{totalHours:D2}:{minutes:D2}:{seconds:D2}";
    }
    
    private void UpdateOverlayUrl()
    {
        var token = UserContext.GetCurrentUserToken();
        var baseUrl = Navigation.BaseUri.TrimEnd('/');
        _overlayUrl = $"{baseUrl}/overlay?token={token}";
    }

    private async Task CopyOverlayLink()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _overlayUrl);
            Snackbar.Add("Overlay URL copied to clipboard!", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Failed to copy to clipboard", Severity.Error);
        }
    }

    private void RegenerateToken()
    {
        UserContext.RegenerateToken();
        UpdateOverlayUrl();
        Snackbar.Add("Token regenerated! Old overlay URLs will no longer work.", Severity.Warning);
    }
    
    private async Task Logout()
    {
        await JSRuntime.InvokeVoidAsync("fetch", "/auth/logout", new { method = "POST" });
        UserContext.ClearUser();
        Snackbar.Add("Logged out successfully", Severity.Info);
        await Task.Delay(500);
        await JSRuntime.InvokeVoidAsync("location.reload");
    }

    [Inject] ISnackbar Snackbar { get; set; }
    [Inject] TwitchIntegrationService TwitchService { get; set; }

    public void Dispose()
    {
        _uiTimer?.Dispose();
    }
}
